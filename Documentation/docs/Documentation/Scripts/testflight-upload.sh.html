<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="html/html; charset=utf-8" />
		<title>testflight-upload.sh Document</title>
		<meta id="xcode-display" name="xcode-display" content="render"/>
		<meta name="viewport" content="width=550" />
		<link rel="stylesheet" type="text/css" href="../../../css/styles.css" media="all" />
		<link rel="stylesheet" type="text/css" media="print" href="../../../css/stylesPrint.css" />	
		<meta name="generator" content="appledoc 2.0.5 (build 789)" />
	</head>
	<body>
		<header id="top_header">
			<div id="library" class="hideInXcode">
				<h1><a id="libraryTitle" href="../index.html">ECConfig </a></h1>
				<a id="developerHome" href="../index.html">Elegant Chaos</a>
			</div>
			
			<div id="title" role="banner">
				<h1 class="hideInXcode" id="pageTitleHeader">testflight-upload.sh Document</h1>
			</div>
			<ul id="headerButtons" role="toolbar"></ul>
		</header>
		<article>
			<a title="testflight-upload.sh Document" name="top"></a>
			<div id="overview_contents" role="main">
				<div id="container">	
					<p>prefix#!/bin/bash
prefix
prefixrm /tmp/upload.log
prefix
prefixTMP=/tmp/testflight-upload
prefixLOG=&ldquo;${TMP}/upload.log&rdquo;
prefixERROR_LOG=&ldquo;${TMP}/error.log&rdquo;
prefix
prefixrm &ldquo;${LLOG}&rdquo;
prefixrm &ldquo;${ERROR_LOG}&rdquo;
prefix
prefixmkdir -p &ldquo;$TMP&rdquo;
prefixecho &ldquo;Uploading&hellip;&rdquo; > &ldquo;${LOG}&rdquo;
prefixecho &ldquo;&rdquo; > &ldquo;${ERROR_LOG}&rdquo;
prefix
prefixGIT=/usr/bin/git
prefix
prefixAPITOKEN=<code>defaults read com.elegantchaos.testflight-upload API_TOKEN</code>
prefixif [[ &ldquo;${APITOKEN}&rdquo; == &ldquo;&rdquo; ]]; then
prefix    echo &ldquo;Need to set the TestFlight API token using &lsquo;defaults write com.elegantchaos.testflight-upload API_TOKEN <token>&rsquo;&rdquo; >> &ldquo;${ERROR_LOG}&rdquo;
prefix    open &ldquo;${ERROR_LOG}&rdquo;
prefix    exit 1
prefixfi
prefix
prefix
prefix# team token and distribution list are per-project settings, so should be passed in
prefixTEAMTOKEN=&ldquo;$1&rdquo;
prefixDISTRIBUTION=&ldquo;$2&rdquo;
prefix
prefix# set this to true to show a confirmation dialog before doing the upload
prefixCONFIRM_MESSAGE=false
prefix
prefix# set this to true to use the git log as the default upload message
prefixDEFAULT_MESSAGE_IS_GIT_LOG=true
prefix
prefixMESSAGE=&ldquo;&rdquo;
prefix
prefixif $DEFAULT_MESSAGE_IS_GIT_LOG; then
prefix    # use the git log since the last upload as the upload message
prefix    MESSAGE=<code>cd "$PROJECT_DIR"; $GIT log --oneline testflight-upload..HEAD</code>
prefix    if [[ $? != 0 ]]; then
prefix        MESSAGE=&ldquo;first upload&rdquo;
prefix    fi
prefix
prefixelse
prefix    # default to the last saved message
prefix    if [ -e &ldquo;${TMP}/upload.txt&rdquo; ]; then
prefix        MESSAGE=<code>cat ${TMP}/upload.txt</code>
prefix    fi
prefixfi
prefix
prefixif $CONFIRM_MESSAGE; then
prefix    # use applescript to ask about the upload
prefix    MESSAGE=<code>osascript -e "tell application id \"com.apple.dt.Xcode\" to text returned of (display dialog \"Upload archive?\" default answer \"$MESSAGE\")"</code>
prefix    if [[ $? != 0 ]] ; then
prefix        echo &ldquo;Upload cancelled&rdquo; >> &ldquo;${LOG}&rdquo;
prefix        exit 1
prefix    fi
prefixfi
prefix
prefix# archive the last commit message, just in case we want it
prefixecho &ldquo;$MESSAGE&rdquo; > &ldquo;${TMP}/upload.txt&rdquo;
prefix
prefixSCRIPT_DIR=<code>dirname $0</code>
prefix
prefix# make the ipa
prefixecho &ldquo;Making $EXECUTABLE_NAME.ipa as ${CODE_SIGN_IDENTITY}&rdquo; >> &ldquo;${LOG}&rdquo;
prefixAPP=&ldquo;$ARCHIVE_PRODUCTS_PATH/Applications/$EXECUTABLE_NAME.app&rdquo;
prefixDSYM=&ldquo;$ARCHIVE_DSYMS_PATH/$EXECUTABLE_NAME.app.dSYM&rdquo;
prefixIPA=&ldquo;$TMPDIR/$EXECUTABLE_NAME.ipa&rdquo;
prefixXCROOT=<code>/usr/bin/xcode-select -print-path</code>
prefixXCRUN=&ldquo;$XCROOT/usr/bin/xcrun&rdquo;
prefix
prefixecho &ldquo;$XCRUN&rdquo; -sdk iphoneos PackageApplication &ldquo;$APP&rdquo; -o &ldquo;$IPA&rdquo; &mdash;sign &ldquo;${CODE_SIGN_IDENTITY}&rdquo; &mdash;embed &ldquo;${APP}/${EMBEDDED_PROFILE_NAME}&rdquo; &amp;> &ldquo;${TMP}/xcrun.txt&rdquo;
prefix
prefix"$XCRUN" -sdk iphoneos PackageApplication &ldquo;$APP&rdquo; -o &ldquo;$IPA&rdquo; &mdash;sign &ldquo;${CODE_SIGN_IDENTITY}&rdquo; &mdash;embed &ldquo;${APP}/${EMBEDDED_PROFILE_NAME}&rdquo; &amp;> &ldquo;${TMP}/xcrun.log&rdquo;
prefix
prefixif [[ $? == 0 ]] ; then
prefix
prefix        CURLLOG=&ldquo;${TMP}/curl.log&rdquo;
prefix
prefix        echo &ldquo;Uploading to Test Flight with notes:&rdquo; >> &ldquo;${LOG}&rdquo;
prefix        echo &ldquo;\&rdquo;${MESSAGE}\&ldquo;&rdquo; >> &ldquo;${LOG}&rdquo;
prefix        echo &ldquo;&rdquo; >> &ldquo;${LOG}&rdquo;
prefix        echo &ldquo;Distribution list ${DISTRIBUTION} will be mailed.&rdquo; >> &ldquo;${LOG}&rdquo;
prefix        echo &ldquo;&rdquo; >> &ldquo;${LOG}&rdquo;
prefix
prefix        zip -q -r &ldquo;${DSYM}.zip&rdquo; &ldquo;${DSYM}&rdquo;
prefix        rm &ldquo;$CURLLOG&rdquo;
prefix        curl http://testflightapp.com/api/builds.json &mdash;form file=&ldquo;@${IPA}&rdquo; &mdash;form dsym=&ldquo;@${DSYM}.zip&rdquo; &mdash;form api_token=&ldquo;${APITOKEN}&rdquo; &mdash;form team_token=&ldquo;${TEAMTOKEN}&rdquo; &mdash;form notes=&ldquo;${MESSAGE}&rdquo; &mdash;form notify=True &mdash;form distribution_lists=&ldquo;${DISTRIBUTION}&rdquo; -o &ldquo;${CURLLOG}&rdquo;
prefix        CONFIG_URL=<code>"${SCRIPT_DIR}/testflight-extract-url.py" &lt; "${CURLLOG}"</code>
prefix
prefix        if [[ $? == 0 ]] ; then
prefix            echo &ldquo;Upload done.&rdquo; >> &ldquo;${LOG}&rdquo;
prefix            open &ldquo;${CONFIG_URL}&rdquo;
prefix
prefix            # update the git tag
prefix            cd &ldquo;$PROJECT_DIR&rdquo;;
prefix            $GIT tag -f testflight-upload
prefix
prefix            #Â clean up if the upload worked
prefix            rm &ldquo;${DSYM}.zip&rdquo;
prefix            rm &ldquo;${IPA}&rdquo;
prefix
prefix        else
prefix            echo &ldquo;Test Flight returned error:&rdquo; > &ldquo;${ERROR_LOG}&rdquo;
prefix            cat &ldquo;${CURLLOG}&rdquo; >> &ldquo;${ERROR_LOG}&rdquo;
prefix            open &ldquo;${ERROR_LOG}&rdquo;
prefix
prefix        fi
prefixelse
prefix
prefix    echo &ldquo;Failed to build IPA&rdquo;  >> &ldquo;${ERROR_LOG}&rdquo;
prefix    open &ldquo;${TMP}/xcrun.log&rdquo;
prefix    exit 1
prefixfi
prefix
prefix</p>
				</div>
				<div id="footer">
					<hr />
					<div class="footer-copyright">
						<p><span class="copyright">&copy; 2012 Elegant Chaos. All rights reserved. (Last updated: 2012-10-18)</span><br />
						
						<span class="generator">Generated by <a href="http://appledoc.gentlebytes.com">appledoc 2.0.5 (build 789)</a>.</span></p>
						
					
					</div>
				</div>
			</div>
		</article>
	</body>
</html>